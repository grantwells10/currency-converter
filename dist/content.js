console.log("[Content] this is content script");let defaultToCurrency="USD";async function fetchAndCacheRates(){try{const e="https://apilayer.net/api/live?access_key=4ccded65216ed540d9d8cf0972afbf90",t=await fetch(e);if(!t)throw new Error("Failed to fetch data");const n=await t.json(),a={data:n.quotes,timestamp:Date.now()};return console.log("Printing data....: "),console.log(n.quotes),await chrome.storage.local.set({exchangeRates:a}),n.quotes}catch(e){throw console.log("CANT FETCH DATA"),e}}async function convertCurrency(e,t,n){const a=await retrieveCache();let o;return o="USD"===t?a[`USD${n}`]:"USD"===n?1/a[`USD${t}`]:a[`USD${n}`]/a[`USD${t}`],e*o}async function retrieveCache(){const e=(await chrome.storage.local.get(["exchangeRates"])).exchangeRates;return e&&e.data?Date.now()-e.timestamp>288e5?(console.log("Data expired, doing another API call..."),await chrome.storage.local.remove("exchangeRates"),await fetchAndCacheRates()):(console.log("Returning cached data..."),e.data):(console.log("No data found, doing initial API call..."),await fetchAndCacheRates())}async function updateCurrencyFromStorage(){const e=await chrome.storage.local.get(["selectedCurrency"]);e.selectedCurrency&&(defaultToCurrency=e.selectedCurrency,console.log("[Content] Updated default currency to:",defaultToCurrency))}async function extractCurrencyAndAmount(e){const t=e.match(/[A-Z]{3}/),n=e.match(/[\d,]+\.?\d*/);let a=null;return n&&(a=parseFloat(n[0].replace(/,/g,""))),{currency:t?t[0]:null,number:a||null}}function createPopup(e,t){var n=document.createElement("div");n.style.position="fixed",n.style.top=t.top-50+"px",n.style.left=t.left+"px",n.style.backgroundColor="#fff",n.style.border="1px solid #000",n.style.padding="10px";var a=document.createElement("div");return a.textContent=defaultToCurrency+" "+e,n.appendChild(a),n.id="myPopup",n}document.addEventListener("mouseup",(async e=>{var t=window.getSelection(),n=t.toString().trim();if(console.log("[Content] selection: "+t),n&&""!==n){var a=t.getRangeAt(0).getBoundingClientRect();try{await updateCurrencyFromStorage();const e=await extractCurrencyAndAmount(n),t=createPopup((await convertCurrency(e.number,e.currency,defaultToCurrency)).toFixed(2),a);document.body.appendChild(t),document.addEventListener("mousedown",(function(e){t.contains(e.target)||(t.parentNode.removeChild(t),document.removeEventListener("mousedown",arguments.callee))}))}catch(e){throw e}}}));